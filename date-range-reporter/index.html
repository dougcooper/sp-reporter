<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Date Range Reporter</title>

    <style>
      :root {
        /* Light theme colors (default) */
        --bg-primary: #f5f5f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f9f9f9;
        --bg-code: #fafafa;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-tertiary: #999999;
        --border-color: #e0e0e0;
        --border-light: #ddd;
        --accent-color: #1976d2;
        --accent-hover: #1565c0;
        --accent-active: #0d47a1;
        --shadow: rgba(0, 0, 0, 0.1);
        --shadow-strong: rgba(0, 0, 0, 0.2);
      }

      body.dark-theme {
        /* Dark theme colors */
        --bg-primary: #1e1e1e;
        --bg-secondary: #2d2d2d;
        --bg-tertiary: #383838;
        --bg-code: #252525;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --text-tertiary: #808080;
        --border-color: #404040;
        --border-light: #505050;
        --accent-color: #42a5f5;
        --accent-hover: #64b5f6;
        --accent-active: #90caf9;
        --shadow: rgba(0, 0, 0, 0.3);
        --shadow-strong: rgba(0, 0, 0, 0.5);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        padding: 20px;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px var(--shadow);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 24px;
        color: var(--accent-color);
        transition: color 0.3s ease;
      }

      .input-section {
        margin-bottom: 24px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        transition: background-color 0.3s ease;
      }

      .input-group {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .input-field {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }

      input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-light);
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }

      input[type="date"]:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--shadow);
      }

      .checkbox-field {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent-color);
      }

      .checkbox-field label {
        margin-bottom: 0;
        cursor: pointer;
        user-select: none;
      }

      button {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
      }

      button:hover {
        background: var(--accent-hover);
      }

      button:active {
        background: var(--accent-active);
      }

      button:disabled {
        background: var(--text-tertiary);
        cursor: not-allowed;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }

      .secondary-btn {
        background: #757575;
      }

      .secondary-btn:hover {
        background: #616161;
      }

      .report-section {
        margin-top: 24px;
      }

      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .report-stats {
        font-size: 14px;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }

      .report-content {
        background: var(--bg-code);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 16px;
        min-height: 400px;
        height: 60vh;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        width: 100%;
        resize: vertical;
        color: var(--text-primary);
      }

      .report-content:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--shadow);
      }

      .report-content::placeholder {
        color: var(--text-tertiary);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      .date-section {
        margin-bottom: 16px;
      }

      .date-header {
        font-weight: bold;
        color: var(--accent-color);
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 2px solid var(--accent-color);
        transition: color 0.3s ease, border-color 0.3s ease;
      }

      .task-item {
        padding-left: 16px;
        margin: 4px 0;
      }

      .no-tasks {
        padding-left: 16px;
        color: var(--text-tertiary);
        font-style: italic;
        transition: color 0.3s ease;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        transition: color 0.3s ease;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 16px;
        border-left: 4px solid #c62828;
      }

      body.dark-theme .error {
        background: #5c1a1a;
        color: #ff8a80;
        border-left-color: #ff5252;
      }

      .info {
        background: #e3f2fd;
        color: #1565c0;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 16px;
        border-left: 4px solid #1976d2;
        font-size: 14px;
      }

      body.dark-theme .info {
        background: #1a3a52;
        color: #90caf9;
        border-left-color: #42a5f5;
      }

      .saved-reports-section {
        margin-top: 24px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        transition: background-color 0.3s ease;
      }

      .saved-reports-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .saved-reports-header h2 {
        font-size: 18px;
        color: var(--text-primary);
      }

      .saved-reports-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .saved-report-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      .saved-report-item:hover {
        background: var(--bg-primary);
        border-color: var(--accent-color);
      }

      .saved-report-item.selected {
        background: var(--bg-primary);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px var(--shadow);
      }

      .report-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent-color);
      }

      .report-info {
        flex: 1;
        min-width: 0;
      }

      .report-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .report-meta {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .report-actions {
        display: flex;
        gap: 8px;
      }

      .icon-btn {
        background: transparent;
        color: var(--text-secondary);
        padding: 6px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 18px;
        transition: background-color 0.2s ease, color 0.2s ease;
        line-height: 1;
      }

      .icon-btn:hover {
        background: var(--bg-tertiary);
        color: var(--accent-color);
      }

      .icon-btn.delete:hover {
        color: #f44336;
      }

      .empty-state {
        text-align: center;
        padding: 32px;
        color: var(--text-tertiary);
        font-style: italic;
      }

      .bulk-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .bulk-actions button {
        padding: 6px 12px;
        font-size: 13px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 24px;
        max-width: 800px;
        max-height: 80vh;
        width: 90%;
        box-shadow: 0 4px 16px var(--shadow-strong);
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-header h3 {
        font-size: 18px;
        color: var(--text-primary);
        margin: 0;
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
      }

      .modal-report-content {
        background: var(--bg-code);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 16px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .close-btn {
        background: transparent;
        color: var(--text-secondary);
        padding: 4px 8px;
        font-size: 24px;
        line-height: 1;
      }

      .close-btn:hover {
        color: var(--text-primary);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>📊 Date Range Task Reporter</h1>

      <div class="info">
        Select a date range to generate a report of all tasks completed during that period.
      </div>

      <div class="input-section">
        <div class="input-group">
          <div class="input-field">
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" />
          </div>
          <div class="input-field">
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" />
          </div>
          <button id="generateBtn">Generate Report</button>
        </div>
        <div class="checkbox-field">
          <input type="checkbox" id="excludeEmptyDates" checked />
          <label for="excludeEmptyDates">Exclude dates with no completed tasks</label>
        </div>
        <div class="checkbox-field">
          <input type="checkbox" id="includeNotes" />
          <label for="includeNotes">Include notes for each task</label>
        </div>
      </div>

      <div class="saved-reports-section">
        <div class="saved-reports-header">
          <h2>💾 Saved Reports</h2>
          <div class="bulk-actions" id="bulkActions" style="display: none;">
            <span id="selectedCount" style="font-size: 13px; color: var(--text-secondary);"></span>
            <button id="deleteSelectedBtn" class="secondary-btn">🗑️ Delete Selected</button>
          </div>
        </div>
        <div id="savedReportsList" class="saved-reports-list">
          <div class="empty-state">No saved reports yet. Generate a report and save it to see it here.</div>
        </div>
      </div>

      <div class="report-section" id="reportSection" style="display: none;">
        <div class="report-header">
          <div class="report-stats" id="reportStats"></div>
          <div class="button-group">
            <button id="saveBtn" class="secondary-btn">💾 Save Report</button>
            <button id="copyBtn" class="secondary-btn">📋 Copy to Clipboard</button>
          </div>
        </div>
        <textarea class="report-content" id="reportContent" placeholder="No report generated yet. Select a date range and click &quot;Generate Report&quot;."></textarea>
      </div>
    </div>

    <!-- Modal for viewing saved reports -->
    <div id="viewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalReportName"></h3>
          <button class="icon-btn close-btn" onclick="closeViewModal()">×</button>
        </div>
        <div class="modal-body">
          <div id="modalReportContent" class="modal-report-content"></div>
        </div>
        <div class="modal-footer">
          <button id="modalCopyBtn" class="secondary-btn">📋 Copy to Clipboard</button>
          <button onclick="closeViewModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
      // Theme detection and management
      function detectTheme() {
        try {
          // Check if parent window has dark theme class
          if (window.parent && window.parent.document) {
            const parentBody = window.parent.document.body;
            const isDark = parentBody.classList.contains('dark-theme') || 
                          parentBody.classList.contains('isDarkTheme') ||
                          parentBody.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
              document.body.classList.add('dark-theme');
            } else {
              document.body.classList.remove('dark-theme');
            }
          }
        } catch (e) {
          // If we can't access parent (cross-origin), check system preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-theme');
          }
        }
      }

      // Watch for theme changes in parent
      function watchThemeChanges() {
        try {
          if (window.parent && window.parent.document) {
            const observer = new MutationObserver(detectTheme);
            observer.observe(window.parent.document.body, {
              attributes: true,
              attributeFilter: ['class', 'data-theme']
            });
          }
        } catch (e) {
          // Can't observe parent, use media query instead
          if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addListener(detectTheme);
          }
        }
      }

      // Initialize theme on load
      detectTheme();
      watchThemeChanges();

      // Initialize dates
      const today = new Date();

      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const generateBtn = document.getElementById('generateBtn');
      const copyBtn = document.getElementById('copyBtn');
      const saveBtn = document.getElementById('saveBtn');
      const reportSection = document.getElementById('reportSection');
      const reportContent = document.getElementById('reportContent');
      const reportStats = document.getElementById('reportStats');
      const excludeEmptyDatesCheckbox = document.getElementById('excludeEmptyDates');
      const includeNotesCheckbox = document.getElementById('includeNotes');
      const savedReportsList = document.getElementById('savedReportsList');
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const viewModal = document.getElementById('viewModal');
      const modalReportName = document.getElementById('modalReportName');
      const modalReportContent = document.getElementById('modalReportContent');
      const modalCopyBtn = document.getElementById('modalCopyBtn');

      let savedReports = [];
      let currentReport = null;
      let selectedReportIds = new Set();

      // Set default dates to past seven days (including today)
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 6);
      startDateInput.valueAsDate = sevenDaysAgo;
      endDateInput.valueAsDate = today;

      // Load saved reports on startup
      loadSavedReports();

      // Persistence functions
      async function loadSavedReports() {
        try {
          const data = await PluginAPI.loadPluginData();
          savedReports = data?.savedReports || [];
          renderSavedReports();
        } catch (error) {
          console.error('Error loading saved reports:', error);
          savedReports = [];
          renderSavedReports();
        }
      }

      async function saveSavedReports() {
        try {
          await PluginAPI.savePluginData({ savedReports });
        } catch (error) {
          console.error('Error saving reports:', error);
          PluginAPI.showSnack({
            msg: 'Failed to save reports',
            type: 'ERROR',
          });
        }
      }

      function renderSavedReports() {
        if (savedReports.length === 0) {
          savedReportsList.innerHTML = '<div class="empty-state">No saved reports yet. Generate a report and save it to see it here.</div>';
          return;
        }

        savedReportsList.innerHTML = savedReports
          .sort((a, b) => b.savedAt - a.savedAt)
          .map(report => `
            <div class="saved-report-item" data-id="${report.id}">
              <input type="checkbox" class="report-checkbox" data-id="${report.id}" onclick="event.stopPropagation(); toggleReportSelection('${report.id}')">
              <div class="report-info" onclick="viewReport('${report.id}')">
                <div class="report-name">${escapeHtml(report.name)}</div>
                <div class="report-meta">${formatDateRange(report.startDate, report.endDate)} • ${report.totalTasks} tasks • Saved ${formatRelativeTime(report.savedAt)}</div>
              </div>
              <div class="report-actions">
                <button class="icon-btn" onclick="event.stopPropagation(); viewReport('${report.id}')" title="View report">👁️</button>
                <button class="icon-btn delete" onclick="event.stopPropagation(); deleteReport('${report.id}')" title="Delete report">🗑️</button>
              </div>
            </div>
          `).join('');
        
        updateBulkActions();
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDateRange(startDate, endDate) {
        if (startDate === endDate) {
          return new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        return `${new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
      }

      function formatRelativeTime(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        return new Date(timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      async function saveReport() {
        if (!currentReport) {
          PluginAPI.showSnack({
            msg: 'No report to save',
            type: 'ERROR',
          });
          return;
        }

        const name = prompt('Enter a name for this report:', `Report ${formatDateRange(currentReport.startDate, currentReport.endDate)}`);
        if (!name || name.trim() === '') {
          return;
        }

        const newReport = {
          id: `report-${Date.now()}`,
          name: name.trim(),
          startDate: currentReport.startDate,
          endDate: currentReport.endDate,
          content: currentReport.content,
          totalTasks: currentReport.totalTasks,
          savedAt: Date.now(),
        };

        savedReports.push(newReport);
        await saveSavedReports();
        renderSavedReports();

        PluginAPI.showSnack({
          msg: 'Report saved successfully!',
          type: 'SUCCESS',
          ico: 'save',
        });
      }

      function viewReport(reportId) {
        const report = savedReports.find(r => r.id === reportId);
        if (!report) return;

        modalReportName.textContent = report.name;
        modalReportContent.textContent = report.content;
        viewModal.classList.add('show');
      }

      function closeViewModal() {
        viewModal.classList.remove('show');
      }

      async function deleteReport(reportId) {
        if (!confirm('Are you sure you want to delete this report?')) {
          return;
        }

        savedReports = savedReports.filter(r => r.id !== reportId);
        selectedReportIds.delete(reportId);
        await saveSavedReports();
        renderSavedReports();

        PluginAPI.showSnack({
          msg: 'Report deleted',
          type: 'SUCCESS',
        });
      }

      function toggleReportSelection(reportId) {
        if (selectedReportIds.has(reportId)) {
          selectedReportIds.delete(reportId);
        } else {
          selectedReportIds.add(reportId);
        }
        updateBulkActions();
        updateCheckboxes();
      }

      function updateCheckboxes() {
        document.querySelectorAll('.report-checkbox').forEach(checkbox => {
          checkbox.checked = selectedReportIds.has(checkbox.dataset.id);
        });
      }

      function updateBulkActions() {
        const count = selectedReportIds.size;
        if (count > 0) {
          bulkActions.style.display = 'flex';
          selectedCount.textContent = `${count} selected`;
        } else {
          bulkActions.style.display = 'none';
        }
      }

      async function deleteSelectedReports() {
        const count = selectedReportIds.size;
        if (count === 0) return;

        if (!confirm(`Are you sure you want to delete ${count} report${count > 1 ? 's' : ''}?`)) {
          return;
        }

        savedReports = savedReports.filter(r => !selectedReportIds.has(r.id));
        selectedReportIds.clear();
        await saveSavedReports();
        renderSavedReports();

        PluginAPI.showSnack({
          msg: `${count} report${count > 1 ? 's' : ''} deleted`,
          type: 'SUCCESS',
        });
      }

      async function copyModalReport() {
        try {
          const text = modalReportContent.textContent;
          await navigator.clipboard.writeText(text);

          PluginAPI.showSnack({
            msg: 'Report copied to clipboard!',
            type: 'SUCCESS',
            ico: 'content_copy',
          });
        } catch (error) {
          console.error('Error copying to clipboard:', error);
          PluginAPI.showSnack({
            msg: 'Failed to copy to clipboard',
            type: 'ERROR',
          });
        }
      }

      // Make functions globally accessible for onclick handlers
      window.viewReport = viewReport;
      window.closeViewModal = closeViewModal;
      window.deleteReport = deleteReport;
      window.toggleReportSelection = toggleReportSelection;
      window.copyModalReport = copyModalReport;

      // Format date as YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // Format date for display (e.g., "Monday, January 1, 2024")
      function formatDateDisplay(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }

      // Get all dates in range
      function getDateRange(startDate, endDate) {
        const dates = [];
        const currentDate = new Date(startDate + 'T00:00:00');
        const end = new Date(endDate + 'T00:00:00');

        while (currentDate <= end) {
          dates.push(formatDate(currentDate));
          currentDate.setDate(currentDate.getDate() + 1);
        }

        return dates;
      }

      // Generate report
      async function generateReport() {
        try {
          generateBtn.disabled = true;
          generateBtn.textContent = 'Generating...';

          const startDate = new Date(startDateInput.value + 'T00:00:00');
          const endDate = new Date(endDateInput.value + 'T23:59:59');

          if (startDate > endDate) {
            PluginAPI.showSnack({
              msg: 'Start date must be before or equal to end date',
              type: 'ERROR',
            });
            return;
          }

          // Get both archived and active tasks (completed tasks may not be archived)
          const archivedTasks = await PluginAPI.getArchivedTasks();
          const activeTasks = await PluginAPI.getTasks();
          
          // Combine all tasks
          const allTasks = [...archivedTasks, ...activeTasks];

          // Group tasks by completion date
          const tasksByDate = {};
          let totalTasks = 0;

          // Get all dates in range
          const dateRange = getDateRange(startDateInput.value, endDateInput.value);
          dateRange.forEach(date => {
            tasksByDate[date] = [];
          });

          // Process all tasks (both archived and active)
          allTasks.forEach(task => {
            if (task.isDone && task.doneOn) {
              const taskDate = new Date(task.doneOn);
              const taskDateStr = formatDate(taskDate);

              // Check if task is in date range
              if (taskDateStr >= formatDate(startDate) && taskDateStr <= formatDate(endDate)) {
                if (!tasksByDate[taskDateStr]) {
                  tasksByDate[taskDateStr] = [];
                }
                tasksByDate[taskDateStr].push(task);
                totalTasks++;
              }
            }
          });

          // Generate report in Markdown format
          let reportText = `# Task Completion Report\n\n`;
          reportText += `**Date Range:** ${formatDateDisplay(formatDate(startDate))} - ${formatDateDisplay(formatDate(endDate))}  \n`;
          reportText += `**Generated:** ${new Date().toLocaleString()}  \n`;
          reportText += `**Total Tasks Completed:** ${totalTasks}\n\n`;
          reportText += `---\n\n`;

          // Sort dates
          const sortedDates = Object.keys(tasksByDate).sort();

          // Filter out empty dates if checkbox is checked
          const excludeEmpty = excludeEmptyDatesCheckbox.checked;
          const includeNotes = includeNotesCheckbox.checked;
          const datesToShow = excludeEmpty 
            ? sortedDates.filter(dateStr => tasksByDate[dateStr].length > 0)
            : sortedDates;

          datesToShow.forEach(dateStr => {
            const tasks = tasksByDate[dateStr];
            reportText += `## ${formatDateDisplay(dateStr)}\n\n`;

            if (tasks.length === 0) {
              reportText += `*No tasks completed*\n\n`;
            } else {
              tasks.forEach((task, index) => {
                const timeSpent = task.timeSpentOnDay && task.timeSpentOnDay[dateStr]
                  ? ` *(${Math.round(task.timeSpentOnDay[dateStr] / 60000)} min)*`
                  : '';
                reportText += `- ${task.title}${timeSpent}\n`;
                
                // Include notes if checkbox is checked and task has notes
                if (includeNotes && task.notes && task.notes.trim()) {
                  // Indent the notes for better formatting
                  const indentedNotes = task.notes.trim().split('\n').map(line => `  ${line}`).join('\n');
                  reportText += `${indentedNotes}\n`;
                }
              });
              reportText += `\n`;
            }
          });

          // Update UI
          reportContent.value = reportText;
          reportStats.textContent = `${totalTasks} task${totalTasks !== 1 ? 's' : ''} completed across ${datesToShow.length} day${datesToShow.length !== 1 ? 's' : ''}`;
          reportSection.style.display = 'block';

          // Store current report for saving
          currentReport = {
            startDate: formatDate(startDate),
            endDate: formatDate(endDate),
            content: reportText,
            totalTasks: totalTasks,
          };

          PluginAPI.showSnack({
            msg: `Report generated with ${totalTasks} completed tasks`,
            type: 'SUCCESS',
          });

        } catch (error) {
          console.error('Error generating report:', error);
          PluginAPI.showSnack({
            msg: 'Failed to generate report: ' + error.message,
            type: 'ERROR',
          });
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Report';
        }
      }

      // Copy to clipboard
      async function copyToClipboard() {
        try {
          const text = reportContent.value;
          await navigator.clipboard.writeText(text);

          PluginAPI.showSnack({
            msg: 'Report copied to clipboard!',
            type: 'SUCCESS',
            ico: 'content_copy',
          });
        } catch (error) {
          console.error('Error copying to clipboard:', error);
          PluginAPI.showSnack({
            msg: 'Failed to copy to clipboard',
            type: 'ERROR',
          });
        }
      }

      // Event listeners
      generateBtn.addEventListener('click', generateReport);
      copyBtn.addEventListener('click', copyToClipboard);
      saveBtn.addEventListener('click', saveReport);
      deleteSelectedBtn.addEventListener('click', deleteSelectedReports);
      modalCopyBtn.addEventListener('click', copyModalReport);

      // Close modal when clicking outside
      viewModal.addEventListener('click', (e) => {
        if (e.target === viewModal) {
          closeViewModal();
        }
      });

      // Allow Enter key to generate report
      startDateInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') generateReport();
      });

      endDateInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') generateReport();
      });
    </script>
  </body>
</html>
